# 程式流程圖

此流程圖使用 Mermaid 語法繪製，描述了「Hello UFO」遊戲的核心運作流程。

```mermaid
graph TD
    subgraph "A. 遊戲準備階段"
        A1["使用者開啟網頁(主畫面)"] --> A2{"顯示 '新遊戲' 按鈕"};
        A2 -- "點擊" --> A3["顯示等待畫面(含加入遊戲的QR Code/連結)"];
        A3 --> A4["網頁端連線MQTT Broker並訂閱Topic"];
    end

    subgraph "B. 玩家加入階段"
        B1["玩家用手機開啟控制器頁面"] --> B2{"請求'加速度計'權限"};
        B2 -- "同意" --> B3["顯示 '加入遊戲' 按鈕"];
        B3 -- "點擊" --> B4["手機端連線MQTT Broker"];
        B4 --> B5["發送 'join' 訊息 (含玩家ID)"];
    end

    subgraph "C. 遊戲進行階段"
        C1["網頁端接收 'join' 訊息"] --> C2["將玩家加入列表並隨機分隊"];
        C2 --> C3["更新主畫面，顯示已加入的玩家"];
        C3 --> C4{"主持人點擊 '開始遊戲'"};
        C4 -- "點擊" --> C5["廣播 'game_start' 訊息"];
        C5 --> C6["網頁端啟動外星人上下移動動畫"];
        C6 --> C7["遊戲計時開始"];

        C8["手機端接收 'game_start' 訊息"] --> C9["啟動動作偵測"];
        C9 --> C10{"偵測到'上下擺動'"};
        C10 -- "是" --> C11["發送 'move' 訊息"];
        C10 -- "否" --> C9;

        C12["網頁端接收 'move' 訊息"] --> C13["計算與外星人節奏的時間差"];
        C13 --> C14["根據時間差給予分數"];
        C14 --> C15["更新畫面上該隊伍的分數"];
        C15 --> C16{ "達到勝利分數？"};
    end

    subgraph "D. 遊戲結束階段"
        C16 -- "是" --> D1["廣播 'game_over' 訊息 (含勝利隊伍)"];
        D1 --> D2["停止遊戲動畫與計時"];
        D2 --> D3["顯示勝利隊伍與最終分數"];
        C16 -- "否" --> C6;
        
        D4["手機端接收 'game_over' 訊息"] --> D5["停止動作偵測"];
        D5 --> D6["顯示遊戲結束"];
        D3 --> D7["遊戲流程結束"];
    end

    A4 --> C1;
    B5 -.-> C1;
``` 